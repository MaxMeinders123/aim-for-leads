{
  "name": "Salesforce Status Check - SDR Research Tool",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 */2 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule: Every 2 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300],
      "description": "Runs every 2 hours to check Salesforce status updates"
    },
    {
      "parameters": {
        "resource": "campaignMember",
        "operation": "query",
        "soql": "SELECT Id, ContactId, Contact.Email, CampaignId, Status, HasResponded, FirstRespondedDate, LastModifiedDate FROM CampaignMember WHERE LastModifiedDate >= LAST_N_DAYS:1 ORDER BY LastModifiedDate DESC LIMIT 200",
        "options": {}
      },
      "id": "salesforce-query-campaign-members",
      "name": "Salesforce: Query Recent CampaignMembers",
      "type": "n8n-nodes-base.salesforce",
      "typeVersion": 2,
      "position": [550, 300],
      "credentials": {
        "salesforceOAuth2Api": "salesforce_oauth"
      },
      "description": "Get CampaignMembers updated in last 24 hours"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.totalSize }}",
              "operation": ">",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-has-results",
      "name": "IF: Has Results?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300],
      "description": "Check if any CampaignMembers were returned"
    },
    {
      "parameters": {
        "fieldToSplitOut": "records",
        "options": {}
      },
      "id": "split-out-records",
      "name": "Split Out: Records",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [1050, 250],
      "description": "Split records array into individual items"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ ($env.SUPABASE_URL || 'https://lqrkrzikjlavnltbnnoa.supabase.co') }}/functions/v1/update-prospect-status-from-salesforce",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  salesforce_contact_id: $json.ContactId,\n  contact_email: $json.Contact?.Email,\n  campaign_member_status: $json.Status,\n  has_responded: $json.HasResponded,\n  first_responded_date: $json.FirstRespondedDate,\n  last_modified_date: $json.LastModifiedDate\n}) }}",
        "options": {}
      },
      "id": "http-update-supabase-status",
      "name": "HTTP: Update Supabase Prospect Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1350, 250],
      "description": "Update prospect status in Supabase from Salesforce data"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "aggregate-results",
      "name": "Aggregate: Results",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [1650, 250],
      "description": "Combine all update results"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "summary",
              "name": "summary",
              "value": "={{ JSON.stringify({\n  checked_at: new Date().toISOString(),\n  total_checked: $items().length,\n  message: 'Salesforce status check completed'\n}) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-summary",
      "name": "Set: Summary",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1950, 250],
      "description": "Create summary of status check"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "no-updates",
              "name": "message",
              "value": "No CampaignMembers updated in last 24 hours",
              "type": "string"
            },
            {
              "id": "checked-at",
              "name": "checked_at",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-no-results",
      "name": "Set: No Results",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1050, 350],
      "description": "Message when no updates found"
    }
  ],
  "connections": {
    "schedule-trigger": {
      "main": [
        [
          {
            "node": "salesforce-query-campaign-members",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "salesforce-query-campaign-members": {
      "main": [
        [
          {
            "node": "if-has-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-has-results": {
      "main": [
        [
          {
            "node": "split-out-records",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set-no-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split-out-records": {
      "main": [
        [
          {
            "node": "http-update-supabase-status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "http-update-supabase-status": {
      "main": [
        [
          {
            "node": "aggregate-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aggregate-results": {
      "main": [
        [
          {
            "node": "set-summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "versionId": "1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "salesforce-status-check-workflow-v1"
  },
  "tags": []
}
