{
  "name": "Salesforce Contact Sync (Future - Requires Freddy)",
  "id": "salesforce-sync-future",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "salesforce-contact-sync",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-receive-enriched-prospect",
      "name": "Webhook: Receive Enriched Prospect",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [250, 100],
      "webhookId": "salesforce-contact-sync",
      "description": "Receives enriched prospect data from Lovable app (after Clay enrichment). Body: { prospect_id, first_name, last_name, title, email, phone, mobile, linkedin_url, salesforce_account_id, salesforce_campaign_id }"
    },
    {
      "parameters": {
        "resource": "contact",
        "operation": "query",
        "soql": "=SELECT Id, Email FROM Contact WHERE Email = '{{ $json.body.email }}' AND AccountId = '{{ $json.body.salesforce_account_id }}'",
        "options": {}
      },
      "id": "sf-check-existing",
      "name": "Salesforce: Check Existing Contact",
      "type": "n8n-nodes-base.salesforce",
      "typeVersion": 2,
      "position": [550, 100],
      "credentials": {
        "salesforceOAuth2Api": {
          "id": "Salesforce account 3",
          "name": "Salesforce account 3"
        }
      },
      "description": "Check if Contact already exists by email + AccountId"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.totalSize }}",
              "operation": ">",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-contact-exists",
      "name": "IF: Contact Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 100],
      "description": "Branch based on whether contact already exists in Salesforce"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "contact_id",
              "name": "contact_id",
              "value": "={{ $json.records[0].Id }}",
              "type": "string"
            },
            {
              "id": "is_duplicate",
              "name": "is_duplicate",
              "value": true,
              "type": "boolean"
            }
          ]
        }
      },
      "id": "use-existing",
      "name": "Set: Use Existing Contact",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1100, 50],
      "description": "Contact already exists - use existing ID, mark as duplicate"
    },
    {
      "parameters": {
        "resource": "contact",
        "operation": "create",
        "fieldsToSet": "customObject",
        "fieldsObject": {
          "FirstName": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.first_name }}",
          "LastName": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.last_name }}",
          "Email": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.email }}",
          "Phone": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.phone }}",
          "MobilePhone": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.mobile }}",
          "Title": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.title }}",
          "AccountId": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.salesforce_account_id }}",
          "LinkedIn__c": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.linkedin_url }}"
        },
        "options": {}
      },
      "id": "sf-create-contact",
      "name": "Salesforce: Create Contact",
      "type": "n8n-nodes-base.salesforce",
      "typeVersion": 2,
      "position": [1100, 150],
      "credentials": {
        "salesforceOAuth2Api": {
          "id": "Salesforce account 3",
          "name": "Salesforce account 3"
        }
      },
      "description": "Create new Contact in Salesforce with all enriched data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "contact_id",
              "name": "contact_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "is_duplicate",
              "name": "is_duplicate",
              "value": false,
              "type": "boolean"
            }
          ]
        }
      },
      "id": "extract-new-id",
      "name": "Set: Extract New Contact ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1350, 150],
      "description": "Extract newly created Contact ID"
    },
    {
      "parameters": {
        "resource": "campaignMember",
        "operation": "create",
        "fieldsToSet": "customObject",
        "fieldsObject": {
          "CampaignId": "={{ $('Webhook: Receive Enriched Prospect').item.json.body.salesforce_campaign_id }}",
          "ContactId": "={{ $json.contact_id }}",
          "Status": "Added"
        },
        "options": {}
      },
      "id": "sf-add-to-campaign",
      "name": "Salesforce: Add to Campaign",
      "type": "n8n-nodes-base.salesforce",
      "typeVersion": 2,
      "position": [1500, 100],
      "credentials": {
        "salesforceOAuth2Api": {
          "id": "Salesforce account 3",
          "name": "Salesforce account 3"
        }
      },
      "description": "Create CampaignMember to add Contact to the Campaign"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  status: 'success',\n  contact_id: $json.contact_id || $('Set: Use Existing Contact').item.json.contact_id || $('Set: Extract New Contact ID').item.json.contact_id,\n  is_duplicate: $json.is_duplicate || false,\n  campaign_member_id: $json.id,\n  salesforce_url: 'https://engagetech.salesforce.com/' + ($json.contact_id || $('Set: Use Existing Contact').item.json.contact_id || $('Set: Extract New Contact ID').item.json.contact_id)\n}) }}",
        "options": {}
      },
      "id": "respond-success",
      "name": "Respond: Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1800, 100],
      "description": "Returns { status, contact_id, is_duplicate, campaign_member_id, salesforce_url }"
    }
  ],
  "connections": {
    "webhook-receive-enriched-prospect": {
      "main": [
        [
          {
            "node": "sf-check-existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sf-check-existing": {
      "main": [
        [
          {
            "node": "if-contact-exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-contact-exists": {
      "main": [
        [
          {
            "node": "use-existing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "sf-create-contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "use-existing": {
      "main": [
        [
          {
            "node": "sf-add-to-campaign",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sf-create-contact": {
      "main": [
        [
          {
            "node": "extract-new-id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extract-new-id": {
      "main": [
        [
          {
            "node": "sf-add-to-campaign",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sf-add-to-campaign": {
      "main": [
        [
          {
            "node": "respond-success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "salesforce-sync-future"
  },
  "tags": ["salesforce", "sync", "future"],
  "_note": "This workflow is NOT ACTIVE. It requires Freddy to set up a Connected App in Salesforce first. See SLACK-MESSAGE-FREDDY.md for details."
}
