{
  "name": "Research Workflow (Async Mode)",
  "nodes": [
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4o-mini"
        },
        "responses": {
          "values": [
            {
              "content": "Validate company status for {{ $json.body.company.name }}.\n\nClassify as: Operating, Acquired, Bankrupt, or Not_Found\n\nReturn ONLY valid JSON:\n{\n  \"status\": \"ok\",\n  \"company\": \"{{ $json.body.company.name }}\",\n  \"company_status\": \"Operating|Acquired|Bankrupt|Not_Found\",\n  \"acquiredBy\": \"parent company name if applicable\",\n  \"effectiveDate\": \"YYYY if applicable\",\n  \"notes\": \"brief findings\"\n}\n\nCompany: {{ $json.body.company.name }}\nWebsite: {{ $json.body.company.website }}\nLinkedIn: {{ $json.body.company.linkedin }}"
            }
          ]
        },
        "builtInTools": {
          "webSearch": {
            "searchContextSize": "low"
          }
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -112,
        -608
      ],
      "id": "c7caa677-57f9-45a9-8bbb-1331ade0dc16",
      "name": "Company Check",
      "credentials": {
        "openAiApi": {
          "id": "KSewCTd2Wh09tVkU",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4o-mini"
        },
        "responses": {
          "values": [
            {
              "content": "Find 3-7 technical decision-makers at {{ $json.body.company.name }} for {{ $json.body.campaign.product }}.\n\nRoles: Director+ in infrastructure, cloud, DevOps, security, or IT operations.\nExclude: Support staff, junior roles, HR, CFOs.\n\nReturn ONLY valid JSON:\n{\n  \"status\": \"ok\",\n  \"company\": \"{{ $json.body.company.name }}\",\n  \"contacts\": [\n    {\n      \"first_name\": \"First\",\n      \"last_name\": \"Last\",\n      \"job_title\": \"Real job title\",\n      \"linkedin\": \"linkedin.com/in/profile-slug\",\n      \"priority\": \"High|Medium|Low\",\n      \"priority_reason\": \"Brief reason for match\"\n    }\n  ]\n}\n\nCompany: {{ $json.body.company.name }}\nWebsite: {{ $json.body.company.website }}\nLinkedIn: {{ $json.body.company.linkedin }}"
            }
          ]
        },
        "builtInTools": {
          "webSearch": {
            "searchContextSize": "low"
          }
        },
        "options": {
          "reasoning": {
            "reasoningOptions": {
              "effort": "low"
            }
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -128,
        -400
      ],
      "id": "95dff59d-5f87-466d-ad45-6cde16913da0",
      "name": "Contact Search",
      "credentials": {
        "openAiApi": {
          "id": "KSewCTd2Wh09tVkU",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "f545849d-1d19-43e7-9dfb-11e34166907f",
        "responseMode": "onReceived",
        "responseData": "={\"status\": \"processing\", \"message\": \"Company research started\", \"user_id\": \"{{ $json.body.user_id }}\", \"company_domain\": \"{{ $json.body.company_domain }}\"}",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -640,
        -720
      ],
      "id": "9984191e-d67f-4583-bd55-c15b16444794",
      "name": "Company Research Webhook",
      "webhookId": "f545849d-1d19-43e7-9dfb-11e34166907f"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "845a71b9-f7fd-4466-9599-3cb79e34d3a4",
        "responseMode": "onReceived",
        "responseData": "={\"status\": \"processing\", \"message\": \"Prospect research started\", \"user_id\": \"{{ $json.body.user_id }}\", \"company_domain\": \"{{ $json.body.company_domain }}\"}",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -640,
        -304
      ],
      "id": "a793b868-560d-4430-ad6a-e6c72eab2273",
      "name": "Prospect Research Webhook",
      "webhookId": "845a71b9-f7fd-4466-9599-3cb79e34d3a4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL || 'https://lqrkrzikjlavnltbnnoa.supabase.co' }}/functions/v1/receive-company-results",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  user_id: $json.body.user_id,\n  company_domain: $json.body.company_domain,\n  company: $json['output'][0].content[0].text,\n  status: 'completed',\n  original_payload: $json.original_payload\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        448,
        -608
      ],
      "id": "a947a31a-22f3-4b8f-8aa8-83a52d6594de",
      "name": "Send to Supabase (Company)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f46205fa-aaaf-433c-bb68-4ef4b72a0632",
              "name": "body.user_id",
              "value": "={{ $('Company Research Webhook').item.json.body.user_id }}",
              "type": "string"
            },
            {
              "id": "f5e07b4f-58ed-4c1d-8389-6c773864ed02",
              "name": "body.company_domain",
              "value": "={{ $('Company Research Webhook').item.json.body.company_domain }}",
              "type": "string"
            },
            {
              "id": "2945c78e-a51a-4aa4-b0e0-da5ad7706d8d",
              "name": "output[0].content[0].text",
              "value": "={{ $json.output[0].content[0].text }}",
              "type": "string"
            },
            {
              "id": "original-payload-id",
              "name": "original_payload",
              "value": "={{ $('Company Research Webhook').item.json.body }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        -608
      ],
      "id": "746c8887-aff3-462b-a12d-d23aba3839e6",
      "name": "Format Company Data"
    },
    {
      "parameters": {
        "jsCode": "// Get webhook data (edge function sends fields at top level in body)\nconst webhookData = $('Prospect Research Webhook').item.json.body;\n\n// Get parsed AI response from previous node\nconst parsedContacts = $input.item.json;\n\n// Combine them\nreturn {\n  body: {\n    user_id: webhookData.user_id,\n    company_domain: webhookData.company_domain,\n    company_research_id: webhookData.company_research_id\n  },\n  parsed_contacts: JSON.stringify(parsedContacts)\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        -400
      ],
      "id": "36a52499-396c-4547-81c5-1177120c85f6",
      "name": "Format Prospect Data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL || 'https://lqrkrzikjlavnltbnnoa.supabase.co' }}/functions/v1/receive-prospect-results",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  user_id: $json.body.user_id,\n  company_domain: $json.body.company_domain,\n  company_research_id: $json.body.company_research_id,\n  prospect: $json.parsed_contacts,\n  status: 'completed'\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        656,
        -400
      ],
      "id": "4a74a108-356e-44ae-9d79-d0819d4a5f01",
      "name": "Send to Supabase (Prospect)"
    },
    {
      "parameters": {
        "jsCode": "// Helper: safely get nested fields\nfunction get(obj, path) {\n  return path.reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj);\n}\n\n// Common locations where OpenAI nodes put text\nconst candidates = [\n  ['content', 0, 'text'],\n  ['message', 'content', 0, 'text'],\n  ['output', 0, 'content', 0, 'text'],\n  ['data', 0, 'content', 0, 'text'],\n];\n\n// Find the first non-empty string\nlet rawText;\nfor (const path of candidates) {\n  const v = get($json, path);\n  if (typeof v === 'string' && v.trim()) {\n    rawText = v;\n    break;\n  }\n}\n\nif (!rawText) {\n  const topKeys = Object.keys($json);\n  throw new Error(`Could not find OpenAI text in expected locations. Top-level keys: ${topKeys.join(', ')}`);\n}\n\n// Strip markdown fenced JSON\nconst cleaned = rawText\n  .replace(/^```json\\s*/i, '')\n  .replace(/^```\\s*/i, '')\n  .replace(/```$/i, '')\n  .trim();\n\n// Parse JSON\nlet parsed;\ntry {\n  parsed = JSON.parse(cleaned);\n} catch (err) {\n  throw new Error('Failed to parse OpenAI JSON: ' + err.message + '\\nRaw text (first 200 chars): ' + cleaned.slice(0, 200));\n}\n\n// Return parsed object as n8n JSON\nreturn parsed;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        -400
      ],
      "id": "adfb21e7-e3ad-470a-8b0f-37b4456b2064",
      "name": "Parse Prospect JSON"
    }
  ],
  "pinData": {},
  "connections": {
    "Company Research Webhook": {
      "main": [
        [
          {
            "node": "Company Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prospect Research Webhook": {
      "main": [
        [
          {
            "node": "Contact Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Company Check": {
      "main": [
        [
          {
            "node": "Format Company Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Company Data": {
      "main": [
        [
          {
            "node": "Send to Supabase (Company)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contact Search": {
      "main": [
        [
          {
            "node": "Parse Prospect JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Prospect JSON": {
      "main": [
        [
          {
            "node": "Format Prospect Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Prospect Data": {
      "main": [
        [
          {
            "node": "Send to Supabase (Prospect)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedPerExecution": 10
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "e9cede33a723de861755fc4c3b19745bba65cbc53a84a89eef946fc41c7f58e4"
  },
  "tags": []
}
